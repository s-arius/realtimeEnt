<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Snake Online</title>
<style>
#juego {
  width:500px; height:500px;
  border:2px solid black;
  position:relative;
  background:#fafafa;
}
.jugador {
  width:20px; height:20px;
  position:absolute;
  background:red;
  border-radius:3px;
  color:white;
  text-align:center;
  font-size:10px;
  line-height:20px;
  font-weight:bold;
  text-shadow:0 0 2px black;
}
.fruta {
  width:20px; height:20px;
  position:absolute;
  background:orange;
  border-radius:50%;
}
</style>
</head>
<body>

<h1>Snake Online</h1>

<div id="juego">
  <div class="jugador" id="plantilla"></div>
</div>

<div>
  <input id="server" value="realtimeent.onrender.com">
  <button id="conectar">Conectar</button>
</div>

<script>
var jugadorBluePrint = document.getElementById("plantilla");
jugadorBluePrint.remove();

var miConexion;
var miID = -1;
var fruta;

document.getElementById("conectar").addEventListener("click", ()=>{
  if (miConexion && miConexion.readyState === WebSocket.OPEN) return;

  let host = document.getElementById("server").value.trim().replace(/^https?:\/\//, "");
  miConexion = new WebSocket("wss://" + host);

  miConexion.addEventListener("message", (m)=>{
    const msg = JSON.parse(m.data.toString());

    if (msg.tipo === "new") {
      if (miID === -1) miID = msg.datos.id;
      if (document.getElementById(msg.datos.id)) return;
      const j = jugadorBluePrint.cloneNode();
      j.id = msg.datos.id;
      j.dataset.posx = msg.datos.posx;
      j.dataset.posy = msg.datos.posy;
      j.dataset.dir = msg.datos.dir;
      j.dataset.puntos = msg.datos.puntos;
      j.style.left = msg.datos.posx + "px";
      j.style.top = msg.datos.posy + "px";
      j.style.backgroundColor = msg.datos.color;
      j.innerHTML = msg.datos.puntos;
      document.getElementById("juego").appendChild(j);
    }

    if (msg.tipo === "delete") document.getElementById(msg.datos)?.remove();

    if (msg.tipo === "mover") {
      const j = document.getElementById(msg.datos.id);
      if (j) {
        j.dataset.posx = msg.datos.posx;
        j.dataset.posy = msg.datos.posy;
        j.style.left = msg.datos.posx + "px";
        j.style.top = msg.datos.posy + "px";
      }
    }

    if (msg.tipo === "estadoFruta") {
      if (!fruta) {
        fruta = document.createElement("div");
        fruta.className = "fruta";
        document.getElementById("juego").appendChild(fruta);
      }
      fruta.style.left = msg.datos.posx + "px";
      fruta.style.top = msg.datos.posy + "px";
    }

    if (msg.tipo === "puntuacion") {
      const j = document.getElementById(msg.datos.id);
      if (j) j.innerHTML = msg.datos.puntos;
    }
  });
});

document.addEventListener("keydown", (e)=>{
  if (!miConexion || miConexion.readyState !== WebSocket.OPEN) return;
  const dir = e.key.toLowerCase();
  if (!["w","a","s","d"].includes(dir)) return;
  const j = document.getElementById(miID);
  if (!j) return;
  miConexion.send(JSON.stringify({ tipo:"mover", datos:{
    id: miID, posx: j.dataset.posx, posy: j.dataset.posy, dir
  }}));
});

document.addEventListener("keyup", (e)=>{
  if (!miConexion || miConexion.readyState !== WebSocket.OPEN) return;
  if (!["w","a","s","d"].includes(e.key.toLowerCase())) return;
  const j = document.getElementById(miID);
  if (!j) return;
  miConexion.send(JSON.stringify({ tipo:"mover", datos:{
    id: miID, posx: j.dataset.posx, posy: j.dataset.posy, dir:"0"
  }}));
});

setInterval(()=>{
  const js = document.getElementsByClassName("jugador");
  for (let j of js) {
    let px = +j.dataset.posx;
    let py = +j.dataset.posy;
    if (j.dataset.dir==="w") py-=20;
    if (j.dataset.dir==="s") py+=20;
    if (j.dataset.dir==="a") px-=20;
    if (j.dataset.dir==="d") px+=20;
    px = Math.max(0, Math.min(480, px));
    py = Math.max(0, Math.min(480, py));
    j.dataset.posx = px;
    j.dataset.posy = py;
    j.style.left = px + "px";
    j.style.top = py + "px";
    if (fruta && px==parseInt(fruta.style.left) && py==parseInt(fruta.style.top)) {
      miConexion.send(JSON.stringify({ tipo:"comer", datos:{ id:j.id }}));
    }
  }
},200);
</script>
</body>
</html>
