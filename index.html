<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Snake Online - corregido</title>
<style>
  #juego { width:500px;height:500px;border:2px solid #333;position:relative;background:#fafafa; }
  .jugador { width:20px;height:20px;position:absolute;border-radius:3px;color:#fff;font-size:10px;text-align:center;line-height:20px;font-weight:bold;text-shadow:0 0 2px rgba(0,0,0,0.6); }
  .fruta { width:20px;height:20px;position:absolute;border-radius:50%;background:orange; }
  #bloqueConectar { margin-top:8px; }
</style>
</head>
<body>
  <h1>Snake Online</h1>

  <div id="juego">
    <div class="jugador" id="plantilla"></div>
  </div>

  <div id="bloqueConectar">
    <input id="server" value="realtimeent.onrender.com">
    <button id="conectar">Conectar</button>
    <span id="estado"></span>
  </div>

<script>
/* Nombres y estilo coherentes con tu código original */
var jugadorBluePrint = document.getElementById("plantilla");
jugadorBluePrint.remove();

var miConexion = null;
var miID = -1;
var fruta = null;

/* Crea WebSocket limpiando prefijos comunes */
function crearWebSocketDesdeDireccion(direccionInput) {
  direccionInput = direccionInput.trim();
  if (!direccionInput) throw new Error("Dirección vacía");
  direccionInput = direccionInput.replace(/^https?:\/\//, "");
  if (direccionInput.startsWith("ws://") || direccionInput.startsWith("wss://")) return new WebSocket(direccionInput);
  if (direccionInput.includes("render") || direccionInput.includes("onrender.com") || direccionInput.includes("herokuapp.com")) {
    return new WebSocket("wss://" + direccionInput);
  }
  if (direccionInput.includes(":")) return new WebSocket("ws://" + direccionInput);
  return new WebSocket("ws://" + direccionInput + ":8080");
}

/* Conectar */
document.getElementById("conectar").addEventListener("click", ()=>{
  const estadoEl = document.getElementById("estado");

  // evita múltiples conexiones
  if (miConexion && (miConexion.readyState === WebSocket.OPEN || miConexion.readyState === WebSocket.CONNECTING)) {
    estadoEl.innerText = "ya conectado";
    return;
  }

  const direccion = document.getElementById("server").value.trim();
  if (!direccion) { alert("Introduce la dirección del servidor"); return; }

  try {
    miConexion = crearWebSocketDesdeDireccion(direccion);
  } catch (e) {
    console.error("crearWebSocket error", e);
    estadoEl.innerText = "error crear ws";
    miConexion = null;
    return;
  }

  estadoEl.innerText = "conectando...";

  miConexion.addEventListener("open", ()=> { estadoEl.innerText = "conectado"; console.log("WS abierto"); });
  miConexion.addEventListener("error", (e)=> { estadoEl.innerText = "error"; console.error("WS error", e); });
  miConexion.addEventListener("close", ()=> { estadoEl.innerText = "desconectado"; miConexion = null; miID = -1; console.log("WS cerrado"); });

  miConexion.addEventListener("message", (m)=>{
    let mensaje;
    try { mensaje = JSON.parse(m.data.toString()); } catch(e){ console.warn("no json", m.data); return; }

    // --- nuevo jugador ---
    if (mensaje.tipo === "new") {
      // el primer "new" recibido será tu propio jugador (como en tu código original)
      if (miID === -1) miID = mensaje.datos.id;

      // evitar duplicados
      if (document.getElementById(mensaje.datos.id)) return;

      const nuevo = jugadorBluePrint.cloneNode();
      nuevo.id = mensaje.datos.id;
      nuevo.dataset.posx = (mensaje.datos.posx != null) ? mensaje.datos.posx : 0;
      nuevo.dataset.posy = (mensaje.datos.posy != null) ? mensaje.datos.posy : 0;
      nuevo.dataset.dir  = (mensaje.datos.dir  != null) ? mensaje.datos.dir  : "0";
      nuevo.dataset.puntos = (mensaje.datos.puntos != null) ? mensaje.datos.puntos : 0;
      nuevo.style.left = nuevo.dataset.posx + "px";
      nuevo.style.top  = nuevo.dataset.posy + "px";
      nuevo.style.backgroundColor = mensaje.datos.color || "#c00";
      nuevo.innerHTML = nuevo.dataset.puntos;
      document.getElementById("juego").appendChild(nuevo);
      return;
    }

    // --- eliminar jugador ---
    if (mensaje.tipo === "delete") {
      const el = document.getElementById(mensaje.datos);
      if (el) el.remove();
      return;
    }

    // --- mover recibid desde server (sincronización) ---
    if (mensaje.tipo === "mover") {
      const d = mensaje.datos;
      const el = document.getElementById(d.id);
      if (!el) return;
      el.dataset.posx = (d.posx != null) ? d.posx : el.dataset.posx;
      el.dataset.posy = (d.posy != null) ? d.posy : el.dataset.posy;
      // actualizar también la dirección para mantener sincronía
      el.dataset.dir  = (d.dir  != null) ? d.dir  : el.dataset.dir;
      el.style.left = el.dataset.posx + "px";
      el.style.top  = el.dataset.posy + "px";
      return;
    }

    // --- fruta ---
    if (mensaje.tipo === "estadoFruta") {
      const posx = mensaje.datos.posx;
      const posy = mensaje.datos.posy;
      if (!fruta) {
        fruta = document.createElement("div");
        fruta.className = "fruta";
        document.getElementById("juego").appendChild(fruta);
      }
      fruta.style.left = posx + "px";
      fruta.style.top  = posy + "px";
      return;
    }

    // --- puntuacion ---
    if (mensaje.tipo === "puntuacion") {
      const el = document.getElementById(mensaje.datos.id);
      if (el) { el.dataset.puntos = mensaje.datos.puntos; el.innerHTML = mensaje.datos.puntos; }
      return;
    }
  });
});

/* TECLAS: wasd (ahora sí) 
   Importante: al pulsar actualizo inmediatamente mi DIV y envio al servidor.
*/
document.addEventListener("keydown", (ev)=>{
  const key = ev.key.toLowerCase();
  if (!["w","a","s","d"].includes(key)) return;

  if (!miConexion || miConexion.readyState !== WebSocket.OPEN) return;
  if (miID === -1) return;

  const yo = document.getElementById(miID);
  if (!yo) return;

  // Actualizo la dirección localmente para ver movimiento inmediato
  yo.dataset.dir = key;

  // Envío al servidor la intención de mover (posiciones actuales + dirección)
  const msg = { tipo: "mover", datos: { id: miID, posx: yo.dataset.posx, posy: yo.dataset.posy, dir: key } };
  try { miConexion.send(JSON.stringify(msg)); } catch(e){ console.error("send mover", e); }
});

document.addEventListener("keyup", (ev)=>{
  const key = ev.key.toLowerCase();
  if (!["w","a","s","d"].includes(key)) return;

  if (!miConexion || miConexion.readyState !== WebSocket.OPEN) return;
  if (miID === -1) return;

  const yo = document.getElementById(miID);
  if (!yo) return;

  // parar localmente
  yo.dataset.dir = "0";

  // avisar al servidor
  const msg = { tipo: "mover", datos: { id: miID, posx: yo.dataset.posx, posy: yo.dataset.posy, dir: "0" } };
  try { miConexion.send(JSON.stringify(msg)); } catch(e){ console.error("send stop", e); }
});

/* ANIMACIÓN LOCAL: mueve todos los DIVs según su dataset.dir (incluido el tuyo)
   La actualización local responde instantáneamente al pulsar por el cambio de dataset.dir.
*/
setInterval(()=>{
  const lista = document.getElementsByClassName("jugador");
  if (lista.length < 1) return;
  for (let i=0;i<lista.length;i++){
    const j = lista[i];
    const dir = j.dataset.dir || "0";
    let px = Number(j.dataset.posx) || 0;
    let py = Number(j.dataset.posy) || 0;

    if (dir === "a") px -= 20;
    else if (dir === "d") px += 20;
    else if (dir === "w") py -= 20;
    else if (dir === "s") py += 20;

    if (px < 0) px = 0;
    if (px > 480) px = 480;
    if (py < 0) py = 0;
    if (py > 480) py = 480;

    j.dataset.posx = px;
    j.dataset.posy = py;
    j.style.left = px + "px";
    j.style.top  = py + "px";

    // comprobar fruta y avisar al servidor
    if (fruta) {
      const fx = parseInt(fruta.style.left);
      const fy = parseInt(fruta.style.top);
      if (px === fx && py === fy) {
        if (miConexion && miConexion.readyState === WebSocket.OPEN) {
          try { miConexion.send(JSON.stringify({ tipo:"comer", datos:{ id: j.id } })); }
          catch(e){ console.error("send comer", e); }
        }
      }
    }
  }
}, 200);
</script>
</body>
</html>
